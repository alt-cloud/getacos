# Дерево файловой системы WEB-сервера

Дерево файловой системы WEB-сервера выглядит следующим образом:
![Дерево файловой системы WEB-сервера](Images/tree.png)

Корневые каталоги:
- `v1/graph`к - PHP-скрипт(ы) сервера графа, обеспечивающие доступ к дереву веток репозитория по протоколу `cincinatti`;
- `ostree` - CLI и PHP скрипты создания репозитория и его веток;
- `ALTCOS` - каталог ostree-репозиториев и промежуточных данных для них.

Каталоги `v1` и `ostree` разворачиваются и поддерживаются из git-репозитория [https://gitea.basealt.ru/kaf/getaltcos](https://gitea.basealt.ru/kaf/getaltcos).

Каталог `ALTCOS` формируется динамически скриптами каталога `ostree` доступны скриптам формирования графа каталога `v1`.

## Структура корневого каталога скриптов `/ostree` и производного каталога репозиториев `/ALTCOS`

Корневой каталог скриптов `/ostree` содержит подкаталоги:
- `bin/` - каталог shell-скриптов для вызова в режиме CLI или WEB-интерфейса из нижеописанных каталогов `update/`, `install/`.
- `update/` - содержит единственный скрипт `index.php`, обеспечивающий по REST-интерфейсу `http://getaltcos.altlinux.org/ostree/update/` обновление текущей версии репозитория (при их наличии) до следующей версии.
- `install` - содержит единственный скрипт `index.php`, обеспечивающий по REST-интерфейсу `http://getaltcos.altlinux.org/ostree/install/` формирование новой ветки репозитория с указанными для установки пакетами

### Структура каталога '/ALTCOS'

Каталог содержит следующие подкаталог `streams/altcos` - каталог репозиториев дистрибутива.

Каждый подкаталог содержит деревья потоков `<arch>/<stream>` для поддержки различных архитектур различных потоков (`stream`).
В настоящий момент `x86_64/sisyphus`, `x86_64/p10`.

Подкаталог потока каталога `images/altcos` содержит каталоги образов по их форматам данных.

Подкаталог потока каталога `streams/altcos` содержит каталоги
`roots`, `bare`, `archive`, 'images', `каталоги подветок`:
- `bare` - репозиторий типа `bare` для разработки системы и разворачивания деревьев. Содержит единственный каталог `repo`.
- `roots` - каталог развернутых деревьев различных коммитов репозитория `bare`;
- `archive` - копия репозитория `bare` в формате `archive` (сжатые данные) для передачи содержимого пользователю;
- `images` - каталог образов различных форматов (`qcow2`, `iso`, ...);
- каталоги подветок содержат:
  * YML-файл `ALTCODfile.yml` описания действий по созданию подветки;
  * каталог `root` дополнительных подкаталогов и файлов, включаемых в подветку;
  * каталог `roots` - каталог развернутых деревьев различных коммитов репозитория `bare`;


### Структура каталога shell-скриптов `/ostree/bin`

Перед запуском скриптов должна быть определена переменная `DOCUMENT_ROOT`, хранящая путь до корневого репозитория:
```
# export DOCUMENT_ROOT=/var/www/vhosts/getaltcos
```

- `createALTCOStar.sh` - создание tar-файла `~/out/altcos-<date>-x86_64.tar` начального дистрибутива с символической ссылкой `~out/ataltcos-latest-x86_64.tar`.
- `createRepo.sh` - создание репозитория на основе tar-файла
- `ostree_log.sh` - отображение логов  по ссылке (`refs`).
Формат:
```
ostree_log.sh ref
```

Пример:
```
$ ostree_log.sh altcos/x86_64/sisyphus
commit fafb6a2406f09bfee76d7d0565c32dd13743f79019d8ff32b2a0c40137e332b6
ContentChecksum:  90456ba35e9af8bccf61bb3516e21dd695feae4a948d2bdc0714a81bce262a26
Date:  2021-08-20 15:49:26 +0000
Version: sisyphus.20210820.0.0
(no subject)
```

- `ostree_checkout.sh` - разворачивание дерева дистрибутива в каталоге `/var/www/vhosts/getaltcos/ALTCOS/streams/altcos/x86_64/sisyphus/roots/<commitId>/` и монтирование overlay-каталогов.
Формат вызова:
```
ostree_checkout.sh ref commitId clear
```

Пример:
```
$ ostree_checkout.sh altcos/x86_64/sisyphus fafb6a2406f09bfee76d7d0565c32dd13743f79019d8ff32b2a0c40137e332b6 all
```
Действия:
- в случае значения 3-го параметра `all` удаление каталога
`/var/www/vhosts/getaltcos/ALTCOS/streams/altcos/x86_64/sisyphus/roots`
и создание нового каталога `roots`;
- разворачивание из каталога репозитория `/var/www/vhosts/getaltcos/ALTCOS/streams/altcos/x86_64/sisyphus/bare/repo` в каталог `/var/www/vhosts/getaltcos/ALTCOS/streams/altcos/x86_64/sisyphus/roots/fafb6a2406f09bfee76d7d0565c32dd13743f79019d8ff32b2a0c40137e332b6` ветки `altcos/x86_64/sisyphus` репозитория с комитом `fafb6a2406f09bfee76d7d0565c32dd13743f79019d8ff32b2a0c40137e332b6`.
- создание символической ссылки `root` на каталог `fafb6a2406f09bfee76d7d0565c32dd13743f79019d8ff32b2a0c40137e332b6`;
- создание подкаталогов `merged`, `upper`, `work`.

- overlay-монтировние каталогов:
```
mount -t overlay overlay -o lowerdir=fafb6a2406f09bfee76d7d0565c32dd13743f79019d8ff32b2a0c40137e332b6,upperdir=./upper,workdir=./work ./merged
```

Нижний каталог `fafb6a2406f09bfee76d7d0565c32dd13743f79019d8ff32b2a0c40137e332b6` монтируется в режиме `только на чтение`.
На него формируется символическая ссылка `root`.

На момент монтирования содержимое каталога `upper` совпадает с содержимым каталога развернутого коммита `root`.
Работа по корректировке развернутого дерева репозитория в дальнейшем производится в каталог `merged`. Все изменения, добавления и удаление файлов в каталог `merged` отображаются в каталоге `upper`. Содержимое каталога `root` остается неизменным.

- `apt-get_update.sh` - обновление пакетной базы в каталоге `merged`.

Формат вызова:
```
apt-get_update.sh ref
```

- `apt-get_dist-upgrade.sh` - установка обновленных пакетов в каталоге `merged`.

Формат вызова:
```
apt-get_dist-upgrade.sh ref
```

- `syncUpdates.sh` - передача обновления из каталога `upper` в каталог коммита `root`.

Формат вызова:
```
syncUpdates.sh ref
```

Файлы, помеченные как специальные файлы типа `character` удаляются из каталогов `upper` и `root`.
Остальное содержимое каталога `upper` копируются в каталог комита `root`.

> (Рассмотреть вариант создания коммита на основе каталога `merged`).

- `ostree_commit.sh` - создание нового коммита в `bare`-репозитории на основе нового содержимого каталога `root`.

Формат вызова:
```
ostree_commit.sh ref newCommitId newVersion
```

> (Рассмотреть вариант создания коммита на основе каталога `merged`).


- `ostree_pull-local.sh` - синхронизировать `bare`-репозиторий разработчика с `archive`-репозиторием клиентов.

Формат вызова:
```
ostree_pull-local.sh
```


### Структура каталога `/v1/graph` графа протокола `cincinatti`
